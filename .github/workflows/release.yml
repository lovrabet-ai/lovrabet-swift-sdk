# =============================================================================
# LovrabetSDK 闭源 XCFramework 构建发布工作流
#
# 架构说明：
#   - 源码存放在阿里云 Codeup（私有）
#   - 本仓库（GitHub 公开）仅用于分发预编译的 XCFramework
#   - CI 从 Codeup 拉取源码 → 构建 → 发布 Release → 更新 Package.swift
#
# 触发方式：
#   1. GitHub UI: Actions → Release → Run workflow
#   2. CLI: gh workflow run release.yml -f version=1.0.0
#
# 所需 Secrets：
#   - CODEUP_USERNAME: Codeup 用户名
#   - CODEUP_PASSWORD: Codeup 密码或 Access Token
# =============================================================================

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "版本号 (例: 1.0.0, 1.2.3-beta.1)"
        required: true
        type: string
      source_ref:
        description: "源码分支或 tag (默认: main)"
        required: false
        default: "main"
        type: string
      platforms:
        description: "构建平台"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - ios-only
          - ios-macos

env:
  FRAMEWORK_NAME: LovrabetSDK

jobs:
  build-and-release:
    name: Build & Release v${{ inputs.version }}
    runs-on: macos-14

    permissions:
      contents: write

    steps:
      # ── 1. 环境准备 ──
      - name: Validate version
        run: |
          VERSION="${{ inputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "::error::无效的版本号格式: $VERSION"
            exit 1
          fi
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Show build environment
        run: |
          echo "Xcode: $(xcodebuild -version | head -1)"
          echo "Swift: $(swift --version | head -1)"
          echo "macOS: $(sw_vers -productVersion)"

      # ── 2. 从 Codeup 拉取源码 ──
      - name: Clone source from Codeup
        run: |
          set -eo pipefail
          SOURCE_DIR="${RUNNER_TEMP}/sdk-source"
          echo "SOURCE_DIR=$SOURCE_DIR" >> "$GITHUB_ENV"

          # 使用 git credential store（避免密码中特殊字符导致 URL 解析失败）
          git config --global credential.helper store
          ENCODED_USER=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=''))" "${{ secrets.CODEUP_USERNAME }}")
          ENCODED_PASS=$(python3 -c "import urllib.parse,sys; print(urllib.parse.quote(sys.argv[1], safe=''))" "${{ secrets.CODEUP_PASSWORD }}")
          echo "https://${ENCODED_USER}:${ENCODED_PASS}@codeup.aliyun.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials

          echo "Cloning ref=${{ inputs.source_ref }} ..."
          git clone --depth 1 --branch "${{ inputs.source_ref }}" \
            "https://codeup.aliyun.com/yuntoo/open/lovrabet-swift-sdk.git" \
            "$SOURCE_DIR"

          rm -f ~/.git-credentials

          if [ ! -d "$SOURCE_DIR/Sources" ]; then
            echo "::error::源码目录结构异常"
            ls -la "$SOURCE_DIR/"
            exit 1
          fi

          SOURCE_COMMIT=$(cd "$SOURCE_DIR" && git rev-parse --short HEAD)
          echo "SOURCE_COMMIT=$SOURCE_COMMIT" >> "$GITHUB_ENV"
          echo "Clone OK (commit: $SOURCE_COMMIT)"

      # ── 3. 构建 XCFramework ──
      - name: Build XCFramework
        run: |
          set -eo pipefail
          cd "$SOURCE_DIR"

          BUILD_DIR="$RUNNER_TEMP/xcf-build"
          OUTPUT_DIR="$RUNNER_TEMP/xcf-output"
          mkdir -p "$BUILD_DIR" "$OUTPUT_DIR"
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> "$GITHUB_ENV"

          PLATFORMS="${{ inputs.platforms }}"

          build_archive() {
            local name="$1"
            local destination="$2"
            echo "::group::Building $name"
            xcodebuild archive \
              -scheme "$FRAMEWORK_NAME" \
              -destination "$destination" \
              -archivePath "$BUILD_DIR/${name}.xcarchive" \
              -derivedDataPath "$BUILD_DIR/DerivedData" \
              SKIP_INSTALL=NO \
              BUILD_LIBRARY_FOR_DISTRIBUTION=YES \
              SWIFT_EMIT_MODULE_INTERFACE=YES \
              2>&1 | tail -5

            # 检查 framework 是否生成（SPM 包的路径可能不同于标准 Xcode 项目）
            local fw_path
            fw_path=$(find "$BUILD_DIR/${name}.xcarchive" -name "${FRAMEWORK_NAME}.framework" -type d 2>/dev/null | head -1)
            if [ -z "$fw_path" ]; then
              echo "::warning::Framework not found at standard location, checking archive contents..."
              find "$BUILD_DIR/${name}.xcarchive/Products" -type f -o -type d 2>/dev/null | head -30
            else
              echo "Framework: $fw_path"
            fi
            echo "::endgroup::"
          }

          # iOS (始终构建)
          build_archive "ios-device"    "generic/platform=iOS"
          build_archive "ios-simulator" "generic/platform=iOS Simulator"

          # macOS
          if [[ "$PLATFORMS" == "all" || "$PLATFORMS" == "ios-macos" ]]; then
            build_archive "macos" "generic/platform=macOS"
          fi

          # tvOS
          if [[ "$PLATFORMS" == "all" ]]; then
            build_archive "tvos-device"    "generic/platform=tvOS"
            build_archive "tvos-simulator" "generic/platform=tvOS Simulator"
          fi

          # watchOS
          if [[ "$PLATFORMS" == "all" ]]; then
            build_archive "watchos-device"    "generic/platform=watchOS"
            build_archive "watchos-simulator" "generic/platform=watchOS Simulator"
          fi

          # 收集所有 framework 路径（适配 SPM 项目的非标准位置）
          echo "::group::Creating XCFramework"
          ARGS=()
          for dir in "$BUILD_DIR"/*.xcarchive; do
            [ -d "$dir" ] || continue
            fw_path=$(find "$dir" -name "${FRAMEWORK_NAME}.framework" -type d 2>/dev/null | head -1)
            if [ -n "$fw_path" ]; then
              echo "Found: $fw_path"
              ARGS+=("-framework" "$fw_path")
            else
              echo "::warning::No framework found in $(basename "$dir"), trying archive mode..."
              ARGS+=("-archive" "$dir" "-framework" "$FRAMEWORK_NAME.framework")
            fi
          done

          echo "Creating XCFramework with ${#ARGS[@]} arguments..."
          xcodebuild -create-xcframework \
            "${ARGS[@]}" \
            -output "$OUTPUT_DIR/$FRAMEWORK_NAME.xcframework"
          echo "::endgroup::"

          if [ ! -d "$OUTPUT_DIR/$FRAMEWORK_NAME.xcframework" ]; then
            echo "::error::XCFramework 创建失败"
            exit 1
          fi

          echo "XCFramework 创建成功"
          ls -lh "$OUTPUT_DIR/"

      # ── 4. 打包 & Checksum ──
      - name: Package & Checksum
        id: package
        run: |
          ZIP_NAME="${FRAMEWORK_NAME}-${VERSION}.zip"
          cd "$OUTPUT_DIR"
          zip -r -y "$ZIP_NAME" "${FRAMEWORK_NAME}.xcframework"
          CHECKSUM=$(swift package compute-checksum "$ZIP_NAME")
          echo "zip_name=$ZIP_NAME"              >> "$GITHUB_OUTPUT"
          echo "zip_path=$OUTPUT_DIR/$ZIP_NAME"  >> "$GITHUB_OUTPUT"
          echo "checksum=$CHECKSUM"              >> "$GITHUB_OUTPUT"
          echo "Package: $ZIP_NAME ($(du -h "$ZIP_NAME" | cut -f1))"
          echo "Checksum: $CHECKSUM"

      # ── 5. 清理源码 ──
      - name: Cleanup source code
        if: always()
        run: rm -rf "${SOURCE_DIR:-/tmp/nonexistent}"

      # ── 6. 创建 GitHub Release ──
      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHECKSUM="${{ steps.package.outputs.checksum }}"
          gh release create "$VERSION" \
            --title "v${VERSION}" \
            --notes "## LovrabetSDK v${VERSION}
          ### Swift Package Manager
          \`\`\`swift
          dependencies: [
              .package(url: \"https://github.com/${{ github.repository }}.git\", from: \"${VERSION}\")
          ]
          \`\`\`
          ### Xcode
          File → Add Package Dependencies → URL: \`https://github.com/${{ github.repository }}.git\`
          ---
          | 项目 | 值 |
          |------|---|
          | Checksum | \`${CHECKSUM}\` |
          | Platforms | \`${{ inputs.platforms }}\` |
          | Source | \`${{ inputs.source_ref }}\` (\`${SOURCE_COMMIT}\`) |" \
            "${{ steps.package.outputs.zip_path }}"

      # ── 7. 更新 Package.swift ──
      - name: Checkout this repo
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Update Package.swift
        run: |
          CHECKSUM="${{ steps.package.outputs.checksum }}"
          ZIP_NAME="${{ steps.package.outputs.zip_name }}"
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${VERSION}/${ZIP_NAME}"
          cat > Package.swift <<SWIFTEOF
          // swift-tools-version: 5.9

          import PackageDescription

          let package = Package(
              name: "LovrabetSDK",
              platforms: [
                  .iOS(.v15),
                  .macOS(.v12),
                  .tvOS(.v15),
                  .watchOS(.v8)
              ],
              products: [
                  .library(
                      name: "LovrabetSDK",
                      targets: ["LovrabetSDK"]
                  ),
              ],
              targets: [
                  .binaryTarget(
                      name: "LovrabetSDK",
                      url: "${DOWNLOAD_URL}",
                      checksum: "${CHECKSUM}"
                  ),
              ]
          )
          SWIFTEOF

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift
          git diff --cached --quiet && echo "No changes" && exit 0
          git commit -m "chore: update to v${VERSION}"
          git tag -f "$VERSION"
          git push origin main --tags --force

      # ── 8. 摘要 ──
      - name: Summary
        if: always()
        run: |
          CHECKSUM="${{ steps.package.outputs.checksum }}"
          echo "## Release v${VERSION}" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| 项目 | 值 |" >> "$GITHUB_STEP_SUMMARY"
          echo "|------|---|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version | \`${VERSION}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Checksum | \`${CHECKSUM}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Platforms | \`${{ inputs.platforms }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Source | \`${{ inputs.source_ref }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo '```swift' >> "$GITHUB_STEP_SUMMARY"
          echo ".package(url: \"https://github.com/${{ github.repository }}.git\", from: \"${VERSION}\")" >> "$GITHUB_STEP_SUMMARY"
          echo '```' >> "$GITHUB_STEP_SUMMARY"
